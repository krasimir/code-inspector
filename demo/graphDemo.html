<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>code-inspector</title>
  <style>
    * {
      box-sizing: border-box;
    }
    pre {
      width: 100%;
      height: 600px;
      resize: none;
      overflow: scroll;
    }
    .container {
      display: grid;
      grid-template-columns: 40% 60%;
    }
    .container > div {
      border-top: solid 1px #999;
    }
    .container > div + div {
      border-left: solid 1px #999;
      padding: 1em;
    }
    section {
      white-space: pre;
    }
  </style>
</head>
<body>
  <p>This demo is generated by <code>src/__tests__/graph.spec.ts</code> file.</p>
  <div class="container">
    <div>
      <pre class="js">import { call, put, select, take, takeLatest } from 'redux-saga/effects';

import {
  QUESTIONNAIRE_ANSWER,
  QUESTIONNAIRE_GO_TO_STEP,
  QUESTIONNAIRE_INITIALIZED,
  SKIP,
} from 'calpamos/src/questionnaire/constants';
import {
  syncUserState,
  flushStepsOnAnswerChange,
} from 'calpamos/src/questionnaire/sagas';
import {
  computeRelativeProgress,
  getNextAvailableStepIndex,
  hasErrors,
  getCurrentStep,
  isLastVisibleStep,
  isQuestionnaireReady,
  getSiteSelectionQuestion,
  getProfileAnswersUpToCurrentStep,
} from 'calpamos/src/questionnaire/selectors';
import {
  answerProcessed,
  updateQuestionnaireProgress,
  answerQuestion,
} from 'calpamos/src/questionnaire/actions';
import { notEligibleToRegister } from 'calpamos/src/questionnaire/utils';
import { isUserAPatient } from 'calpamos/src/registration/selectors';

import validateCurrentStep from './validateCurrentStep';

function* computeQuestionnaireProgress() {
  const progress = yield select(computeRelativeProgress);

  yield put(updateQuestionnaireProgress(progress));
}

export default function* watchQuestionnaireFlow(
  redirectTo,
  answerMatchQuestions,
  checkEligibility
) {
  yield takeLatest(QUESTIONNAIRE_GO_TO_STEP, function*({ current }) {
    const ready = yield select(isQuestionnaireReady);
    if (!ready) {
      yield take(QUESTIONNAIRE_INITIALIZED);
    }

    yield* computeQuestionnaireProgress();

    const beforeAnswering = yield select(getCurrentStep);

    while (true) {
      const newAnswer = yield take(QUESTIONNAIRE_ANSWER);
      if (yield select(isUserAPatient)) {
        if (!notEligibleToRegister(newAnswer, redirectTo)) {
          break;
        }
      }
      yield* flushStepsOnAnswerChange(beforeAnswering, newAnswer);
      const answers = yield select(getProfileAnswersUpToCurrentStep);
      yield* answerMatchQuestions(answers);

      if (yield select(hasErrors)) {
        yield put(answerProcessed());
        continue;
      }
      yield* syncUserState(newAnswer);

      const { total } = yield call(checkEligibility);

      if (total === 0) {
        const siteSelectionQuestion = yield select(getSiteSelectionQuestion);

        if (siteSelectionQuestion) {
          yield put(
            answerQuestion({
              id: siteSelectionQuestion.id,
              value: SKIP,
              inferred: true,
            })
          );
        }
      }
      yield put(answerProcessed());

      if (yield select(isLastVisibleStep)) {
        yield put(updateQuestionnaireProgress(1));
        yield call(redirectTo, `/register`);
        break;
      }

      const nextStepIndex = yield select(getNextAvailableStepIndex);

      yield call(redirectTo, `/questions/${nextStepIndex + 1}`);
      break;
    }
  });
  yield takeLatest(QUESTIONNAIRE_GO_TO_STEP, function*() {
    const ready = yield select(isQuestionnaireReady);
    if (!ready) {
      yield take(QUESTIONNAIRE_INITIALIZED);
    }
    yield validateCurrentStep(redirectTo);
  });
}
</pre>
      <section class="preview-in-mermaid">graph LR
ImportDefaultSpecifier31:831:27("validateCurrentStep")
ImportDefaultSpecifier31:831:27 --> FunctionExpression100:46106:4
FunctionDeclaration33:137:2("computeQuestionnaireProgress")
FunctionDeclaration33:137:2 --> FunctionExpression44:4699:4
VariableDeclarator34:934:57("progress")
VariableDeclarator34:934:57 --> FunctionDeclaration33:137:2
FunctionDeclaration39:16107:2("watchQuestionnaireFlow")
ObjectProperty44:5844:65("current")
ObjectProperty44:5844:65 --> FunctionExpression44:4699:4
VariableDeclarator45:1145:53("ready")
VariableDeclarator45:1145:53 --> FunctionExpression44:4699:4
VariableDeclarator45:1145:53 --> FunctionExpression100:46106:4
VariableDeclarator52:1152:57("beforeAnswering")
VariableDeclarator52:1152:57 --> FunctionExpression44:4699:4
VariableDeclarator55:1355:57("newAnswer")
VariableDeclarator55:1355:57 --> FunctionExpression44:4699:4
VariableDeclarator62:1362:69("answers")
VariableDeclarator62:1362:69 --> FunctionExpression44:4699:4
ObjectProperty71:1571:20("total")
ObjectProperty71:1571:20 --> FunctionExpression44:4699:4
VariableDeclarator74:1574:77("siteSelectionQuestion")
VariableDeclarator74:1574:77 --> FunctionExpression44:4699:4
VariableDeclarator94:1394:68("nextStepIndex")
VariableDeclarator94:1394:68 --> FunctionExpression44:4699:4
VariableDeclarator101:11101:53("ready")
VariableDeclarator101:11101:53 --> FunctionExpression44:4699:4
VariableDeclarator101:11101:53 --> FunctionExpression100:46106:4</section>
    </div>
    <div class="mermaid">graph LR
ImportDefaultSpecifier31:831:27("validateCurrentStep")
ImportDefaultSpecifier31:831:27 --> FunctionExpression100:46106:4
FunctionDeclaration33:137:2("computeQuestionnaireProgress")
FunctionDeclaration33:137:2 --> FunctionExpression44:4699:4
VariableDeclarator34:934:57("progress")
VariableDeclarator34:934:57 --> FunctionDeclaration33:137:2
FunctionDeclaration39:16107:2("watchQuestionnaireFlow")
ObjectProperty44:5844:65("current")
ObjectProperty44:5844:65 --> FunctionExpression44:4699:4
VariableDeclarator45:1145:53("ready")
VariableDeclarator45:1145:53 --> FunctionExpression44:4699:4
VariableDeclarator45:1145:53 --> FunctionExpression100:46106:4
VariableDeclarator52:1152:57("beforeAnswering")
VariableDeclarator52:1152:57 --> FunctionExpression44:4699:4
VariableDeclarator55:1355:57("newAnswer")
VariableDeclarator55:1355:57 --> FunctionExpression44:4699:4
VariableDeclarator62:1362:69("answers")
VariableDeclarator62:1362:69 --> FunctionExpression44:4699:4
ObjectProperty71:1571:20("total")
ObjectProperty71:1571:20 --> FunctionExpression44:4699:4
VariableDeclarator74:1574:77("siteSelectionQuestion")
VariableDeclarator74:1574:77 --> FunctionExpression44:4699:4
VariableDeclarator94:1394:68("nextStepIndex")
VariableDeclarator94:1394:68 --> FunctionExpression44:4699:4
VariableDeclarator101:11101:53("ready")
VariableDeclarator101:11101:53 --> FunctionExpression44:4699:4
VariableDeclarator101:11101:53 --> FunctionExpression100:46106:4</div>
  <script src="../browser/code-inspector.js"></script>
  <script src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
  
  </script>
</body>
</html>